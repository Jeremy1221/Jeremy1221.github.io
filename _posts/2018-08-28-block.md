---
title: Block原理
header: Block原理
description: Block原理
---

##The biggest adventure you can take is to live the life of your dreams

你能经历最大的冒险，就是过你梦想的生活

###Block介绍

block是C语言的扩充，即带有自动变量的匿名函数，它和普通变量一样，可以作为自动变量，函数参数，静态变量，全局变量。

###Block中截获自动变量值

首先我们要理解自动变量是什么？我们观察下面一段代码，一个非常简单的block，打印了val的变量。

	int val = 1;
	void(^blk)(voiod) = ^{
		printf("%d\n", val);
	}
	val = 2;
	blk();
	
>在上面的源码中，block表达式使用了之前声明的自动变量val，虽然我们在之后调用block之前有修改val的值，但是打印出来的结果还是之前的旧值，关于这点大家都知道，但是至于原因是什么，其实就是block保存了val的瞬间值，具体说明我们需要通过了解block的实现原理才清楚。

###Block的定义

>通过将代码转换成c++的源码我们可以发现block的定义。

	int main(int argc, const char * argv[]) {
		int val = 1;
		void (*blk)(void) = ((void (*)())&__main_block_impl_0((void *)__main_block_func_0, &__main_block_desc_0_DATA, val));
		val = 2;
		((void (*)(__block_impl *))((__block_impl *)blk)->FuncPrt)((__block_impl *)blk);
		return 0;
	}
	
我们发现转换后的代码主要包括以下几个结构体：

	// __main_block_impl_0就是block的定义，它也是由几个变量和构造函数组成的。
	
	struct __main_block_impl_0 {
		struct __block_impl impl;
		struct __main_block_desc_0 * Desc;
		int val;	//自动变量备份
		__main_block_impl_0(void *fp, struct __main_block_desc_0 * desc, int _val, int flags=0) : val(_val) {
			impl.isa = &_NSConcreteStackBlock;
			impl.Flags = flags;
			impl.FuncPtr = fp;
			Desc = desc;
		}
	};
	
	struct __block_impl {
		void * isa;			//地址指向
		int Flags;			//某些标志
		int Reserved;		//关于版本升级所需的区域
		void * FuncPtr;		//具体block函数的实现
	}
	
	static struct __main_block_desc_0 {
		size_t reserved;	//关于版本升级所需的区域
		size_t Block_size;	//block的大小
	} __main_block_desc_0_DATA = {0, sizeof(struct __main_block_impl_0)};
	
	// 该函数的参数__cself相当于c++实例方法中的this，也就是OC中的self，指向block自身；
	// 通过读取自身保存的val，最后输出结果
	staic vod __main_block_func_0(struct __main_block_impl_0 * __cself) {
		int val = __csekf->val;	//bound by copy
		printf("%d \n", val);
	}
	
通过上面的结构我么可以发现block的具体结构，我们回过头来继续看之前的自动截获变量的值不会变的问题，我们来看一下转换后的函数调用。

	int val = 1;
	void (*blk)(void) = ((void (*)())&__main_block_impl_0((void *)__main_block_func_0, &_main_block_desc_0_DATA, val);
	val = 2;
	((void (*)(__block_impl *))((__block_impl *)blk)->FuncPtr)((__block_impl *)blk);
	
所以block的结构总结就是下图:

![](https://Jeremy1221.github.io/img/retain_cycle/block_struct.png)

###Block中改写自动变量值

	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	